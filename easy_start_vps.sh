#!/bin/bash
# ==============================================================
# VPS Initial Setup Script
# –ê–≤—Ç–æ—Ä: Funnnik
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤–æ–≥–æ VPS
# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: Ubuntu 22.04 / 24.04+
# –í–µ—Ä—Å–∏—è: 1.1
# ==============================================================

set -e

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ ---
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç root. –ò—Å–ø–æ–ª—å–∑—É–π: sudo bash $0"
  exit 1
fi

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ä–≤–µ—Ä–∞..."

# --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã ---
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤..."
apt list --upgradable || true
sleep 3

echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É..."
apt update && apt upgrade -y
apt install -y curl ufw fail2ban nano htop

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW ---
echo "üß± –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UFW (—Ñ–∞–µ—Ä–≤–æ–ª)..."
ufw --force reset
ufw default deny incoming
ufw default allow outgoing

# –†–∞–∑—Ä–µ—à–∞–µ–º SSH —Ç–æ–ª—å–∫–æ —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥—Å–µ—Ç–µ–π
ufw allow from 62.105.44.145/29 to any port 22
ufw allow from 188.0.160.0/19 to any port 22

# –†–∞–∑—Ä–µ—à–∞–µ–º –ø–∏–Ω–≥ (ICMP) —Ç–æ–ª—å–∫–æ —Å —ç—Ç–∏—Ö –∂–µ –ø–æ–¥—Å–µ—Ç–µ–π
echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º ICMP (ping) —á–µ—Ä–µ–∑ before.rules..."
UFW_RULES="/etc/ufw/before.rules"
if ! grep -q "ufw-before-input" "$UFW_RULES"; then
  echo "–§–∞–π–ª before.rules –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É ICMP."
else
  # –î–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
  grep -q "icmp --icmp-type echo-request" "$UFW_RULES" || cat <<EOF >> "$UFW_RULES"

# --- Custom ICMP rules (added by setup script) ---
-A ufw-before-input -p icmp --icmp-type echo-request -s 62.105.44.145/29 -j ACCEPT
-A ufw-before-input -p icmp --icmp-type echo-request -s 188.0.160.0/19 -j ACCEPT
-A ufw-before-input -p icmp --icmp-type echo-request -j DROP
# --- End custom ICMP rules ---
EOF
fi

ufw logging on
ufw --force enable

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS over HTTPS ---
echo "üåê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º DNS over HTTPS (DoH)..."
RESOLVED_CONF="/etc/systemd/resolved.conf"
cat <<EOF > "$RESOLVED_CONF"
[Resolve]
DNS=1.1.1.1#cloudflare-dns.com 8.8.8.8#dns.google
DNSOverTLS=yes
EOF

systemctl daemon-reload
systemctl restart systemd-resolved
systemctl enable systemd-resolved

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker ---
echo "üê≥ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker..."
curl -fsSL https://get.docker.com | sh
usermod -aG docker $SUDO_USER || true

# --- –í–∫–ª—é—á–µ–Ω–∏–µ TCP BBR ---
echo "‚ö° –í–∫–ª—é—á–∞–µ–º TCP BBR..."
SYSCTL_CONF="/etc/sysctl.conf"
if ! grep -q "tcp_congestion_control=bbr" "$SYSCTL_CONF"; then
  cat <<EOF >> "$SYSCTL_CONF"

# Enable BBR congestion control
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr
EOF
fi
sysctl -p

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Fail2Ban ---
echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Fail2Ban..."
apt install -y fail2ban
systemctl enable fail2ban
systemctl start fail2ban

# --- –§–∏–Ω–∞–ª ---
echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å: sudo reboot"
echo "–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Docker –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ sudo."
